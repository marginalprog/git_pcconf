CREATE OR REPLACE FUNCTION insert_proizv(
	VARCHAR(50))
RETURNS void AS $$
BEGIN
	INSERT INTO proizv_video(name)
	VALUES ($1);
END;
$$ LANGUAGE plpgsql;


CREATE OR REPLACE FUNCTION insert_videocard(
	INT,
	VARCHAR(50),
	VARCHAR(25),
	VARCHAR(25),
	INT,
	VARCHAR(10),
	INT,
	INT,
	VARCHAR(20),
	INT,
	VARCHAR(25),
	INT,
	INT,
	NUMERIC (8,2))
	RETURNS void AS $$
BEGIN
	INSERT INTO videocard(id_proizv,fullname, chipcreator, chipname, vram, 
						  typevram, frequency, bus, interface, monitor,
					   	  resolution, tdp, length, price)
	VALUES ($1, $2, $3, $4, $5, $6, $7, $8, $9, $10, $11, $12, $13);
END;
$$ LANGUAGE plpgsql;





CREATE OR REPLACE FUNCTION insert_skladvideo()
RETURNS trigger
AS $$
BEGIN
	INSERT INTO sklad_videocard(id_izd)
	VALUES (NEW.id);
	RETURN NEW;
END;
$$
LANGUAGE plpgsql;

CREATE TRIGGER sklad_video_insert_trigger
AFTER INSERT
ON "videocard" -- при добавление НОВОЙ видеокарты создаем поле склада
FOR EACH ROW
EXECUTE PROCEDURE insert_skladvideo();

CREATE OR REPLACE FUNCTION insert_order_videocard(
	INT,
	INT,
	DATE)
	RETURNS void AS $$
BEGIN
	INSERT INTO order_videocard(id_izd, kol, date)
	VALUES ($1, $2, $3);
END;
$$ LANGUAGE plpgsql;

CREATE OR REPLACE FUNCTION update_skladvideo()
RETURNS trigger
AS $$
DECLARE
	old_skl_kol int;
	new_skl_kol int;
BEGIN
	old_skl_kol = (SELECT SUM(kol) FROM sklad_videocard
					WHERE id_izd = NEW.id_izd);
	new_skl_kol = old_skl_kol + NEW.kol;
	UPDATE sklad_videocard
	SET kol = new_skl_kol
    	WHERE id_izd=NEW.id_izd;
	RETURN NEW;
END;
$$
LANGUAGE plpgsql;

CREATE TRIGGER update_sklad_videocard_trigger
AFTER INSERT
ON "order_videocard" -- После создания заказа пересчитать количество видеокарт
FOR EACH ROW
EXECUTE PROCEDURE update_skladvideo();


CREATE OR REPLACE FUNCTION get_proizv_videocard()
RETURNS TABLE(id INT, exist BOOLEAN, name VARCHAR(50)) AS $$
	SELECT * FROM proizv_videocard
$$ LANGUAGE sql;


CREATE FUNCTION update_video_dogovor(int, bool) 
RETURNS void AS $$
BEGIN
	UPDATE proizv_videocard SET exist = $2 WHERE id = $1;
END;
$$ LANGUAGE plpgsql;



select  get_proizv_videocard()


SELECT insert_proizv('GIGABYTE')
SELECT insert_videocard(1,'GIGABYTE GeForce RTX 3050 EAGLE OC', 'Nvidia', 'RTX 3050', 8, 'GDDR6', 1552, 256, 'PCI-E 4.0', 4, '7680x4320', 130, 28, 29250);
SELECT insert_order_videocard(5, 2, '05.04.2023')

SELECT insert_proizv('MSI')
SELECT insert_videocard(2,'MSI AMD Radeon RX 6600', 'AMD', 'RX 6600', 8, 'GDDR6', 2044, 128, 'PCI-E 4.0', 4, '7680x4320', 132, 33, 26490);
SELECT insert_order_videocard(6, 2, '05.04.2023')



